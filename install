#!/usr/bin/env bash
set -e

echo "========================================="
echo "  Paper Digest ì„¤ì¹˜"
echo "========================================="
echo ""

# Check dependencies
echo "1. í•„ìˆ˜ í”„ë¡œê·¸ë¨ í™•ì¸ ì¤‘..."
echo ""

missing_deps=()

if ! command -v python3 &> /dev/null; then
    missing_deps+=("python3")
fi

if ! command -v uv &> /dev/null; then
    missing_deps+=("uv")
fi

if ! command -v claude &> /dev/null; then
    missing_deps+=("claude")
fi

if [ ${#missing_deps[@]} -ne 0 ]; then
    echo "âŒ ë‹¤ìŒ í”„ë¡œê·¸ë¨ì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤:"
    for dep in "${missing_deps[@]}"; do
        echo "   - $dep"
    done
    echo ""
    echo "ì„¤ì¹˜ ë°©ë²•:"
    echo "  python3: https://www.python.org/downloads/"
    echo "  uv:      curl -LsSf https://astral.sh/uv/install.sh | sh"
    echo "  claude:  https://docs.anthropic.com/en/docs/cli"
    echo ""
    exit 1
fi

echo "âœ“ python3, uv, claude CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
echo ""

# Install Python dependencies
echo "2. Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
uv sync
echo "âœ“ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"
echo ""

# Create necessary directories
mkdir -p digests .tmp

# Interactive configuration
echo "========================================="
echo "  ì„¤ì • íŒŒì¼ ìƒì„±"
echo "========================================="
echo ""

if [ -f "config.yaml" ]; then
    read -p "config.yaml íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "ê¸°ì¡´ config.yamlì„ ìœ ì§€í•©ë‹ˆë‹¤."
        echo ""
    else
        rm config.yaml
    fi
fi

if [ ! -f "config.yaml" ]; then
    echo "ê´€ì‹¬ ìˆëŠ” ë…¼ë¬¸ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
    echo ""
    echo "ì˜ˆì‹œ:"
    echo "  - AI/ML ë¶„ì•¼: large language model, transformer, reinforcement learning"
    echo "  - ê´‘ê³  ë¶„ì•¼: bid shading, programmatic advertising, real-time bidding"
    echo "  - ì¶”ì²œ ì‹œìŠ¤í…œ: recommender systems, collaborative filtering, personalization"
    echo ""

    # Loop until valid input
    while true; do
        echo "í‚¤ì›Œë“œë¥¼ ì‰¼í‘œ(,) ë˜ëŠ” ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•´ì„œ ì…ë ¥í•˜ì„¸ìš”:"
        echo "(ë˜ëŠ” ê·¸ëƒ¥ Enterë¥¼ ëˆ„ë¥´ë©´ ìœ„ AI/ML ì˜ˆì‹œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤)"
        read -r keywords_input

        # Empty input - use default example
        if [[ -z "$keywords_input" ]]; then
            echo ""
            echo "ì˜ˆì‹œ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: large language model, transformer, reinforcement learning"
            keywords_input="large language model, transformer, reinforcement learning"
        fi

        # Parse keywords (comma or space separated)
        # Replace commas with spaces, then split by spaces
        keywords_input=$(echo "$keywords_input" | tr ',' ' ')
        read -ra keywords_array <<< "$keywords_input"

        # Filter empty and trim whitespace
        keywords_yaml=""
        keyword_count=0
        for keyword in "${keywords_array[@]}"; do
            keyword=$(echo "$keyword" | xargs)  # trim whitespace
            if [ -n "$keyword" ]; then
                keywords_yaml="${keywords_yaml}    - \"${keyword}\"\n"
                ((keyword_count++))
            fi
        done

        # Check if at least one keyword
        if [ $keyword_count -gt 0 ]; then
            break
        else
            echo ""
            echo "âš ï¸  ìµœì†Œ 1ê°œ ì´ìƒì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."
            echo ""
        fi
    done

    # Generate config.yaml
    cat > config.yaml << 'CONFIGEOF'
# Paper Digest Configuration

# =============================================================================
# ê´€ì‹¬ ë¶„ì•¼ ì„¤ì •
# =============================================================================
interests:
  # arXiv ì¹´í…Œê³ ë¦¬ (AI/ML ë¶„ì•¼ ê¸°ë³¸ ì„¤ì •)
  # ë‹¤ë¥¸ ë¶„ì•¼ë¥¼ ì›í•˜ì‹ ë‹¤ë©´ https://arxiv.org/category_taxonomy ì°¸ê³ í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”
  categories:
    - cs.LG      # Machine Learning
    - cs.AI      # Artificial Intelligence
    - cs.CL      # Computation and Language (NLP)
    - cs.CV      # Computer Vision
    - stat.ML    # Statistics - Machine Learning

  # ê²€ìƒ‰ í‚¤ì›Œë“œ
  keywords:
KEYWORDS_PLACEHOLDER

# =============================================================================
# ê´€ì‹¬ í•™íšŒ/ì €ë„ (ì„ íƒ)
# ì•„ë˜ ëª©ë¡ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
# =============================================================================
venues:
  conferences:
    - NeurIPS
    - ICML
    - ICLR
    - AAAI
  journals: []

# =============================================================================
# ê´€ì‹¬ ì €ì (ì„ íƒ)
# í•„ìš”ì‹œ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”
# =============================================================================
authors: []
# ì˜ˆì‹œ:
#   - "Yann LeCun"
#   - "Geoffrey Hinton"

# =============================================================================
# ë…¼ë¬¸ ì„ ì • ì„¤ì •
# =============================================================================
selection:
  num_papers: 2        # ë§¤ì¼ ìš”ì•½í•  ë…¼ë¬¸ ìˆ˜
  max_candidates: 50   # ê²€ìƒ‰í•  ìµœëŒ€ í›„ë³´ ìˆ˜
  days_recent: 7       # ìµœê·¼ Nì¼ ì´ë‚´ ë…¼ë¬¸ë§Œ

# =============================================================================
# ìš”ì•½ ì„¤ì •
# =============================================================================
summary:
  model: "sonnet"      # Claude ëª¨ë¸ (sonnet, opus, haiku)

# =============================================================================
# ì¶œë ¥ ì„¤ì •
# =============================================================================
output:
  directory: "./digests"
  filename_format: "%Y-%m-%d"
  html_enabled: true

# =============================================================================
# ì•Œë¦¼ ì„¤ì •
# =============================================================================
notification:
  enabled: true
  sound: "Glass"

# =============================================================================
# ê³ ê¸‰ ì„¤ì •
# =============================================================================
advanced:
  api_timeout: 30
  history_file: "./.tmp/history.json"
  history_retention_days: 90
  debug: false
CONFIGEOF

    # Replace placeholder with actual keywords
    sed -i.bak "s/KEYWORDS_PLACEHOLDER/$(echo -e "$keywords_yaml")/" config.yaml
    rm config.yaml.bak

    echo ""
    echo "âœ“ config.yaml íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
    echo ""
    echo "ğŸ’¡ ì¶”ê°€ ì„¤ì •:"
    echo "   - ê´€ì‹¬ í•™íšŒ/ì €ë„ ì¶”ê°€: config.yamlì˜ venues ì„¹ì…˜ ìˆ˜ì •"
    echo "   - ê´€ì‹¬ ì €ì ì¶”ê°€: config.yamlì˜ authors ì„¹ì…˜ì— ì¶”ê°€"
    echo "   - ì¹´í…Œê³ ë¦¬ ë³€ê²½: config.yamlì˜ categories ì„¹ì…˜ ìˆ˜ì •"
    echo "     (í˜„ì¬ëŠ” AI/ML ë¶„ì•¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤)"
    echo ""
fi

# Cron job setup
echo "========================================="
echo "  ìë™ ì‹¤í–‰ ì„¤ì • (ì„ íƒ)"
echo "========================================="
echo ""
echo "ğŸ“… ìë™ ì‹¤í–‰ì„ ì„¤ì •í•˜ë©´ ë§¤ì¼ ì§€ì •í•œ ì‹œê°„ì— ë…¼ë¬¸ì„ ê²€ìƒ‰í•˜ê³  ìš”ì•½í•´ì¤ë‹ˆë‹¤."
echo ""
echo "ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
echo "  1) ì˜ˆ, ì„¤ì •í• ê²Œìš”"
echo "  2) ì•„ë‹ˆìš”, ë‚˜ì¤‘ì— ì§ì ‘ ì„¤ì •í• ê²Œìš”"
echo ""
read -p "ì„ íƒ (1 ë˜ëŠ” 2): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[1]$ ]]; then
    # Check if crontab is available
    if ! command -v crontab &> /dev/null; then
        echo ""
        echo "âŒ crontabì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        echo ""
        echo "ìë™ ì‹¤í–‰ ê¸°ëŠ¥ì€ macOS/Linuxì˜ cron ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
        echo "ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•˜ê±°ë‚˜, ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
        echo ""
        echo "ì°¸ê³ : ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë‚˜ì¤‘ì— ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        echo "  scripts/schedule daily 9:00"
        echo ""
    else
        echo ""
        echo "ì‹¤í–‰ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
        echo ""
        echo "í˜•ì‹: ì‹œê°„(0-23) ë˜ëŠ” ì‹œê°„:ë¶„"
        echo "ì˜ˆì‹œ:"
        echo "  9      = ì˜¤ì „ 9ì‹œ"
        echo "  9:30   = ì˜¤ì „ 9ì‹œ 30ë¶„"
        echo "  14     = ì˜¤í›„ 2ì‹œ"
        echo "  8:15   = ì˜¤ì „ 8ì‹œ 15ë¶„"
        echo ""
        read -p "ì‹¤í–‰ ì‹œê°„: " time_input

        # Parse time
        if [[ "$time_input" =~ ^([0-9]{1,2}):([0-9]{2})$ ]]; then
            HOUR="${BASH_REMATCH[1]}"
            MINUTE="${BASH_REMATCH[2]}"
        elif [[ "$time_input" =~ ^([0-9]{1,2})$ ]]; then
            HOUR="${BASH_REMATCH[1]}"
            MINUTE="0"
        else
            echo "âŒ ì‹œê°„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’(ì˜¤ì „ 9ì‹œ)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤."
            HOUR="9"
            MINUTE="0"
        fi

        # Validate
        if [ "$HOUR" -lt 0 ] || [ "$HOUR" -gt 23 ]; then
            echo "âŒ ì‹œê°„ì€ 0-23 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤. ê¸°ë³¸ê°’(ì˜¤ì „ 9ì‹œ)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤."
            HOUR="9"
            MINUTE="0"
        fi

        if [ "$MINUTE" -lt 0 ] || [ "$MINUTE" -gt 59 ]; then
            echo "âŒ ë¶„ì€ 0-59 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤. ê¸°ë³¸ê°’(ì˜¤ì „ 9ì‹œ)ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤."
            HOUR="9"
            MINUTE="0"
        fi

        # Setup cron job
        PROJECT_ROOT="$(pwd)"
        RUN_SCRIPT="${PROJECT_ROOT}/run"
        LOG_FILE="${PROJECT_ROOT}/.tmp/cron.log"
        CRON_CMD="$MINUTE $HOUR * * * cd $PROJECT_ROOT && $RUN_SCRIPT >> $LOG_FILE 2>&1"

        # Remove existing entries
        crontab -l 2>/dev/null | grep -v -F "$PROJECT_ROOT" | crontab - 2>/dev/null || true

        # Add new entry
        if (crontab -l 2>/dev/null || true; echo "$CRON_CMD") | crontab - 2>/dev/null; then
            echo ""
            echo "âœ“ ë§¤ì¼ ${HOUR}ì‹œ $(printf '%02d' $MINUTE)ë¶„ì— ìë™ ì‹¤í–‰ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo ""
            echo "ğŸ“ ìë™ ì‹¤í–‰ ê´€ë¦¬ ëª…ë ¹ì–´:"
            echo "   í˜„ì¬ ì„¤ì • í™•ì¸:  scripts/schedule"
            echo "   ì‹œê°„ ë³€ê²½:       scripts/schedule daily ${HOUR}:$(printf '%02d' $MINUTE)"
            echo "   ìë™ ì‹¤í–‰ ì·¨ì†Œ:   scripts/schedule off"
            echo ""
            echo "ğŸ’¡ ìë™ ì‹¤í–‰ ì·¨ì†Œ (ìˆ˜ë™ ë°©ë²•):"
            echo "   í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”:"
            echo "   ./scripts/schedule off"
            echo ""
        else
            echo ""
            echo "âŒ ìë™ ì‹¤í–‰ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            echo ""
            echo "cron ê¶Œí•œì´ ì—†ê±°ë‚˜ cron ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•´ ë³´ì„¸ìš”:"
            echo "  scripts/schedule daily ${HOUR}:$(printf '%02d' $MINUTE)"
            echo ""
        fi
    fi
elif [[ $REPLY =~ ^[2]$ ]]; then
    echo ""
    echo "ë‚˜ì¤‘ì— ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
    echo "  scripts/schedule daily 9:00"
    echo ""
else
    echo ""
    echo "ê±´ë„ˆëœë‹ˆë‹¤."
    echo ""
fi

echo "========================================="
echo "  ì„¤ì¹˜ ì™„ë£Œ!"
echo "========================================="
echo ""
echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ Paper Digestë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
echo ""
echo "  ./run           # ë…¼ë¬¸ ê²€ìƒ‰ ë° ìš”ì•½ ìƒì„±"
echo "  ./run --dry-run # ê²€ìƒ‰ë§Œ (ìš”ì•½ ìƒì„± ì•ˆ í•¨)"
echo ""
echo "ê²°ê³¼ íŒŒì¼ì€ digests/ í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤."
echo ""
echo "ğŸ“– ë” ìì„¸í•œ ì‚¬ìš©ë²•ì€ README.mdë¥¼ í™•ì¸í•˜ì„¸ìš”!"
echo ""

# Ask if user wants to run now
echo "========================================="
echo "  ë°”ë¡œ ì‹¤í–‰í•´ ë³¼ê¹Œìš”?"
echo "========================================="
echo ""
echo "ì§€ê¸ˆ ë°”ë¡œ Paper Digestë¥¼ ì‹¤í–‰í•´ì„œ ë…¼ë¬¸ì„ ë°›ì•„ë³´ì‹œê² ìŠµë‹ˆê¹Œ?"
echo ""
echo "  1) ì˜ˆ, ë°”ë¡œ ì‹¤í–‰í• ê²Œìš”"
echo "  2) ì•„ë‹ˆìš”, ë‚˜ì¤‘ì— ì§ì ‘ ì‹¤í–‰í• ê²Œìš”"
echo ""
read -p "ì„ íƒ (1 ë˜ëŠ” 2): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[1]$ ]]; then
    echo ""
    echo "Paper Digestë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
    echo ""
    ./run
else
    echo ""
    echo "ë‚˜ì¤‘ì— ./run ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ì„¸ìš”!"
    echo ""
fi

echo ""
